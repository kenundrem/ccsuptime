<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Microsoft 365 Status — Unofficial</title>
  <!-- Tailwind via CDN for a quick demo -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { ok: '#16a34a', warn: '#ea580c', bad: '#dc2626' } } } }
  </script>
  <style>
    .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,0.7); }
    .dark .glass { background: rgba(17,24,39,0.5); }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900 dark:from-slate-900 dark:to-slate-950 dark:text-slate-100 min-h-screen">
  <header class="sticky top-0 z-10 border-b border-slate-200/60 dark:border-slate-700/40 bg-white/70 dark:bg-slate-900/70 glass">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="h-9 w-9 rounded-2xl bg-gradient-to-br from-indigo-500 to-sky-500"></div>
      <div class="flex-1">
        <h1 class="text-xl font-semibold">Microsoft 365 Status <span class="text-slate-400 text-base">(Unofficial)</span></h1>
        <p class="text-xs text-slate-500">Parses the XML from admin.microsoft.com / portal.office.com service status endpoints.</p>
      </div>
      <button id="themeBtn" class="px-3 py-1.5 text-sm rounded-xl border border-slate-300/70 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">Toggle theme</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div class="md:col-span-2 flex items-center gap-3">
        <input id="endpoint" class="w-full rounded-2xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/70 px-4 py-2 outline-none" placeholder="Endpoint (XML)" value="https://admin.microsoft.com/api/servicestatus/index" />
        <button id="loadBtn" class="rounded-2xl px-4 py-2 bg-slate-900 text-white dark:bg-white dark:text-slate-900">Load</button>
      </div>
      <div class="flex items-center gap-3">
        <input id="search" class="w-full rounded-2xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/70 px-4 py-2" placeholder="Search services..." />
      </div>
    </section>

    <section class="mb-4 flex flex-wrap items-center gap-2">
      <button data-filter="all" class="fchip active rounded-full px-3 py-1.5 text-sm border border-slate-300 dark:border-slate-700">All</button>
      <button data-filter="issues" class="fchip rounded-full px-3 py-1.5 text-sm border border-slate-300 dark:border-slate-700">Issues only</button>
      <button data-filter="healthy" class="fchip rounded-full px-3 py-1.5 text-sm border border-slate-300 dark:border-slate-700">Healthy only</button>
      <span id="lastUpdated" class="ml-auto text-xs text-slate-500"></span>
    </section>

    <div id="alert" class="hidden mb-4 rounded-xl border border-amber-300/60 bg-amber-50/80 text-amber-900 p-3 text-sm"></div>

    <section id="grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></section>
  </main>

  <template id="cardTpl">
    <article class="card rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/70 shadow-sm hover:shadow transition-shadow">
      <div class="p-4">
        <div class="flex items-start justify-between gap-2">
          <h3 class="name font-medium text-slate-900 dark:text-slate-100"></h3>
          <span class="state inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium border"></span>
        </div>
        <div class="mt-2 text-xs text-slate-500" data-id></div>
      </div>
      <div class="msgs hidden border-t border-slate-100 dark:border-slate-800">
        <details class="group open:bg-slate-50/50 dark:open:bg-slate-800/30 open:rounded-b-2xl p-4">
          <summary class="cursor-pointer text-sm text-slate-600 dark:text-slate-300">Messages</summary>
          <ul class="mt-2 space-y-2 text-sm"></ul>
        </details>
      </div>
    </article>
  </template>

  <script>
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));

    const statePill = (isUp) => {
      const span = document.createElement('span');
      span.className = `inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium border ${isUp ? 'bg-emerald-50/80 text-emerald-800 border-emerald-200' : 'bg-rose-50/80 text-rose-800 border-rose-200'}`;
      span.innerHTML = `${isUp ? '● Healthy' : '● Issue'}`;
      return span;
    };

    function getXNil(node){
      if(!node) return false;
      // Support xsi:nil="true"
      return node.getAttributeNS('http://www.w3.org/2001/XMLSchema-instance','nil') === 'true' || node.getAttribute('i:nil') === 'true';
    }

    function parseXMLtoServices(xmlDoc){
      const out = [];
      const services = xmlDoc.getElementsByTagName('Service');
      for(const s of services){
        const get = (tag) => (s.getElementsByTagName(tag)[0]?.textContent || '').trim();
        const id = get('Id');
        const name = get('Name') || id || 'Unknown service';
        const isUp = (get('IsUp') || '').toLowerCase() === 'true';
        const messagesNode = s.getElementsByTagName('Messages')[0];
        const messages = [];
        if(messagesNode && !getXNil(messagesNode)){
          for(const m of messagesNode.getElementsByTagName('Message')){
            const text = m.textContent.trim();
            if(text) messages.push({ text });
          }
        }
        out.push({ id, name, isUp, messages });
      }
      return out;
    }

    async function fetchXML(url){
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const doc = new DOMParser().parseFromString(text, 'application/xml');
      // basic parse error detection
      if(doc.getElementsByTagName('parsererror').length){
        throw new Error('Failed to parse XML');
      }
      return doc;
    }

    function render(services){
      const grid = qs('#grid');
      grid.innerHTML = '';
      const frag = document.createDocumentFragment();
      services.forEach(svc => {
        const tpl = qs('#cardTpl').content.cloneNode(true);
        const card = tpl.querySelector('.card');
        tpl.querySelector('.name').textContent = svc.name;
        tpl.querySelector('[data-id]').textContent = svc.id || '';
        const state = tpl.querySelector('.state');
        state.replaceWith(statePill(svc.isUp));
        if(svc.messages?.length){
          const msgsWrap = tpl.querySelector('.msgs');
          const list = msgsWrap.querySelector('ul');
          svc.messages.forEach(m => { const li = document.createElement('li'); li.textContent = m.text; list.appendChild(li); });
          msgsWrap.classList.remove('hidden');
        }
        frag.appendChild(tpl);
      });
      grid.appendChild(frag);
    }

    function filterAndRender(){
      const term = qs('#search').value.toLowerCase();
      const filter = document.querySelector('.fchip.active')?.dataset.filter || 'all';
      const visible = window.__services.filter(s => {
        if(term && !(s.name.toLowerCase().includes(term) || (s.id||'').toLowerCase().includes(term))) return false;
        if(filter === 'issues' && s.isUp) return false;
        if(filter === 'healthy' && !s.isUp) return false;
        return true;
      });
      render(visible);
    }

    async function load(){
      const alert = qs('#alert');
      alert.classList.add('hidden');
      const input = qs('#endpoint');
      const candidates = [input.value, 'https://portal.office.com/api/servicestatus/index'];
      let xml;
      let lastErr;
      for(const url of candidates){
        try { xml = await fetchXML(url); break; }
        catch(e){ lastErr = e; }
      }
      if(!xml){
        alert.textContent = `Could not load status XML (likely CORS-blocked). Try serving this page from a small proxy that fetches the XML server-side.`;
        alert.classList.remove('hidden');
        return;
      }
      const services = parseXMLtoServices(xml);
      window.__services = services;
      filterAndRender();
      qs('#lastUpdated').textContent = `Last updated ${new Date().toLocaleString()}`;
    }

    // UI wiring
    addEventListener('DOMContentLoaded', () => {
      qsa('.fchip').forEach(btn => btn.addEventListener('click', () => {
        qsa('.fchip').forEach(b => b.classList.remove('active','bg-slate-900','text-white','dark:bg-white','dark:text-slate-900'));
        btn.classList.add('active','bg-slate-900','text-white','dark:bg-white','dark:text-slate-900');
        filterAndRender();
      }));
      qs('#search').addEventListener('input', filterAndRender);
      qs('#loadBtn').addEventListener('click', load);
      // initial load
      load();
      // theme toggle
      qs('#themeBtn').addEventListener('click', () => document.documentElement.classList.toggle('dark'));
      // auto-refresh every 5 minutes
      setInterval(load, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
